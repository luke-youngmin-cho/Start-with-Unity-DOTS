# Entities 1.4 — 새 기능·개선점 & 주요 버그 픽스

## 1. API / 언어 변화
- **사용 중단(Deprecated) API**  
  `Entities.ForEach`, `Job.WithCode`, `IAspect`, `ComponentLookup.GetRef*Optional` 이 더 이상 권장되지 않습니다.  
  - **대안**: `IJobEntity` + `SystemAPI.Query`, 순수 `IJob`, `TryGetRefRO` / `TryGetRefRW`
- **안전한 컴포넌트 접근**  
  - `ComponentLookup.TryGetRefRO / TryGetRefRW` — 존재 확인과 참조 획득을 한 번에 처리  
  - `ArchetypeChunk.GetBufferAccessorRO / RW`, `GetUntypedBufferAccessorReinterpret<T>` — 읽기·쓰기 의존성을 명시하거나 런타임 타입 버퍼를 재해석

## 2. Editor & 툴링
- **System Inspector**
  - *Queries* 탭에 Disabled / Present / Absent / None 상태 표기
  - *Dependencies* 탭 신설 → 시스템 간 의존 관계 시각화
- **Query Window**
  - 프리팹을 아이콘으로 표시해 식별 용이
- `WorldUnmanaged.GetSystemTypeIndex(SystemHandle)` 추가

## 3. 빌드·콘텐츠 파이프라인
- `RemoteContentCatalogBuildUtility.PublishContent` 개선
  - 모든 오브젝트·씬을 **콘텐츠 세트**로 분류, `DebugCatalog.txt` 자동 생성
  - 디렉터리 대신 **파일 목록**을 직접 지정하여 필요한 파일만 배포 가능
- **부트스트랩 보호**  
  `DisableBootstrapOverridesAttribute` — 외부 패키지가 의도치 않게 `ICustomBootstrap`을 덮어쓰지 못하도록 방지

## 4. 퍼포먼스 개선

### 4-1 측정 환경
- **측정 도구**: Unity Profiler Timeline + Deep Profiling 모드
- **테스트 플랫폼**: Windows Standalone, Android (Vulkan API)
- **비교 버전**: Entities 1.2.3 vs 1.4.0

### 4-2 구체적 성능 개선 사항

| 영역 | 개선 내용 | 측정 결과 |
|------|-----------|-----------|
| **엔진 시작** | `TypeManager.Initialize` 최적화 | 1000+ 컴포넌트 타입 프로젝트에서 **950ms → 480ms** (2.0×) |
| **런타임 API** | `SetSharedComponentManaged` 배치 처리 | SharedComponent 변경 시 **15ms → 8ms** (1.9×) |
| **엔티티 순회** | `ChunkEntityEnumerator` 생성 최적화 | EnableMask 활성화 시 **2.1ms → 1.4ms** (1.5×) |
| **메모리 할당** | `IEntitiesPlayerSettings` GC 감소 | 1프레임당 **2.4KB → 0.8KB** 할당량 감소 |

### 4-3 회귀 및 주의사항

| 시나리오 | 성능 변화 | 권장 대안 |
|----------|-----------|-----------|
| **Mono + EnableMask 비활성화** | **1.2ms → 2.3ms** (1.9× 느려짐) | IL2CPP 빌드 또는 `for` 루프 직접 사용 |
| **복잡한 쿼리 필터링** | 약간의 오버헤드 증가 | `SystemAPI.QueryBuilder()` 캐싱 활용 |
| **소규모 프로젝트 (<100 컴포넌트)** | 개선 효과 미미 | 기존 패턴 유지 가능 |

## 5. 기타 개선
- **Custom Editor**: `WeakReferencePropertyDrawer` 개선으로 WeakObject 필드 표시 향상
- **문서 보강**: `UnityObjectRef`, `LinkedEntityGroup`, Transform 관련 문서 확장

## 6. 주요 버그 픽스
- 1.4에서 해결된 문제들은 **패키지 Changelog**에 상세 기재되어 있습니다. 업그레이드 전 반드시 확인하세요.

---

## 업그레이드 체크리스트
1. **컴파일 경고 제거**: `Entities.ForEach` → `IJobEntity`, `TryGetRef*` API로 교체  
2. **새 툴링 활용**: *Dependencies* 탭으로 시스템 의존 순환 점검, *Query Window*로 프리팹 쿼리 오류 확인  
3. **성능 검증**: 대규모 프로젝트에서 Startup / Chunk 순회 성능을 Profiler로 측정. Mono 환경은 `ChunkEntityEnumerator` 경로 주의  
4. **Changelog / Upgrade Guide** 확인: 추가 변경 사항 및 잠재적 회귀 이슈 파악
